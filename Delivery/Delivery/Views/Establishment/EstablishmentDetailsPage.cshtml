@model Delivery.ViewModels.EstablishmentDeteilsViewModel

@{
    ViewBag.Title = Model.Name; 
}

<div class="container">
    <div class="text-center mb-4">
        <img src="@Model.Image" alt="Фото заведения" class="img-fluid cafe-image">
        <div class="description-box text-center">
            <h4 class="mb-3" style="word-wrap: break-word;">@Model.Name</h4>
            <p class="mt-2" style="word-wrap: break-word;">@Model.Description</p>
        </div>
    </div>

    @if (User.IsInRole("admin"))
    {
        <div class="text-center mt-4 mb-3" style="display: flex; justify-content: center; gap: 10px;">
            <a asp-action="CreateDish" asp-route-establishmentId="@Model.Id" class="btn btn-outline-success mr-1">Добавить блюдо</a>
            <form asp-action="EditEstablishment" asp-controller="Establishment" method="get" asp-route-id="@Model.Id">
                <button type="submit" class="btn btn-dark ">Редактировать заведение</button>
            </form>
            <form asp-action="DeleteEstablishment" asp-controller="Establishment" method="post">
                <input type="hidden" name="id" value="@Model.Id"/>
                <button type="submit" class="btn btn-danger">Удалить заведение</button>
            </form>
        </div>
    }
    
    <h3 class="mb-3 text-center">Меню</h3>
    
    @if (Model.Dishes != null && Model.Dishes.Count > 0)
    {
        <div class="row">
            @foreach (var dish in Model.Dishes)
            {
                <div class="col-sm-3 mb-3 d-flex">
                    <div class="card1 shadow position-relative">
                        <img src="@dish.Image" alt="Фото блюда" style="height: 150px;">
                        <div class="card-body text-start">
                            <p class="card-text">@dish.Name</p>
                            <p class="card-text">Описание: <em class="not-bold text-break">@dish.Description</em></p>
                            <p class="card-text">@dish.Price сом</p>
                            <button class="btn btn-success btn-sm position-absolute bottom-0 end-0 m-2 add-to-basket"
                                    data-dish-id="@dish.Id"
                                    data-establishment-id="@Model.Id">
                                Добавить в корзину
                            </button>

                            @if (User.IsInRole("admin"))
                            {
                                <a asp-action="EditDish" asp-route-dishId="@dish.Id" class="btn btn-secondary mr-1"><i class="fa-solid fa-pen-to-square"></i></a>
                                <form asp-action="DeleteDish" asp-controller="Establishment" method="post" class="d-inline">
                                    <input type="hidden" name="dishId" value="@dish.Id" />
                                    <button type="submit" class="btn btn-danger"><i class="fa-solid fa-trash-can"></i></button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <h4 class="text-center">Меню временно недоступно</h4>
    }
    @if (Model.Basket != null)
    {
        <h3 class="mb-3 text-center">Ваша корзина</h3>
        <div id="basketContainer">
            <ul class="list-group">
                @foreach (var basketDish in Model.Basket.BasketDishes)
                {
                    <li class="list-group-item">
                        @basketDish.Dish.Name - @basketDish.Quantity x @basketDish.Dish.Price сом
                        <button class="btn btn-danger btn-sm float-end remove-from-basket" 
                                data-dish-id="@basketDish.DishId"
                                data-establishment-id="@Model.Id">
                            Удалить
                        </button>
                    </li>
                }
            </ul>
            <div class="mt-3">
                <strong>Общая стоимость:</strong> @Model.Basket.BasketDishes.Sum(bd => bd.Dish.Price * bd.Quantity) сом
            </div>
        </div>
    }
    else
    {
        <h4 class="text-center">Корзина пуста</h4>
    }
</div>

@section Scripts {
    
    <script>
        $(document).ready(function () {
            $('.add-to-basket').click(function () {
                var dishId = $(this).data('dish-id');
                var establishmentId = $(this).data('establishment-id');

                $.ajax({
                    type: 'POST',
                    url: "/Establishment/AddToBasket/",
                    data: { dishId: dishId, establishmentId: establishmentId },
                    success: function (response) {
                        updateBasket(response);
                    }
                });
            });
            $(document).on('click', '.remove-from-basket', function () {
                var dishId = $(this).data('dish-id');
                var establishmentId = $(this).data('establishment-id');

                $.ajax({
                    type: 'POST',
                    url: '/Establishment/RemoveFromBasket/',
                    data: { dishId: dishId, establishmentId: establishmentId },
                    success: function (response) {
                        updateBasket(response);
                    },
                    error: function () {
                        alert('Ошибка при удалении товара из корзины');
                    }
                });
            });
            function updateBasket(response) {
                var basketContainer = $('#basketContainer');
                var basketHtml = '<h3 class="mb-3 text-center">Ваша корзина</h3>';

                if (response.success && response.BasketDishes.length > 0) {
                    basketHtml += '<ul class="list-group">';
                    response.BasketDishes.forEach(function (item) {
                        basketHtml += '<li class="list-group-item">';
                        basketHtml += item.DishName + ' - ' + item.Quantity + ' x ' + item.Price + ' сом';
                        basketHtml += '<button class="btn btn-danger btn-sm float-end remove-from-basket" data-dish-id="' + item.DishId + '" data-establishment-id="' + response.establishmentId + '">Удалить</button>';
                        basketHtml += '</li>';
                    });
                    basketHtml += '</ul>';
                    basketHtml += '<div class="mt-3"><strong>Общая стоимость:</strong> ' + response.TotalPrice + ' сом</div>';
                } else {
                    basketHtml += '<h4 class="text-center">Корзина пуста</h4>';
                }

                basketContainer.html(basketHtml);
            }
        });
    </script>
}
